name: ğŸ§  MLOps CI/CD Pipeline

on:
  push:
    branches:
      - main

permissions:
  contents: write  # Needed for committing model updates

jobs:
  mlops-pipeline:
    runs-on: ubuntu-latest

    steps:
      # ğŸ Step 1: Checkout Repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # ğŸ§° Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # ğŸ“¦ Step 3: Install Dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install mlflow scikit-learn xgboost tensorflow joblib dvc

      # ğŸ§© Step 4: (Optional) Configure DVC for dataset sync
      - name: Pull data with DVC (if using remote storage)
        run: |
          if [ -f "dvc.yaml" ] || [ -f "data.dvc" ]; then
            dvc pull || echo "âš ï¸ DVC pull skipped (no remote configured)"
          else
            echo "â„¹ï¸ No DVC files found â€” skipping data sync."
          fi

      # ğŸ§  Step 5: Train models and log results
      - name: Train models with MLflow
        run: |
          python src/train_with_mlflow.py

      # ğŸ’¾ Step 6: Commit and push new trained models
      - name: Commit and push trained model
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f models/*
          git commit -m "ğŸ¤– Auto retrain: updated model [skip ci]" || echo "No changes to commit"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸš€ Step 7: Trigger Render deploy (via Deploy Hook)
      - name: Trigger Render Deployment
        run: |
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}
